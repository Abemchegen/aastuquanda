// Prisma schema for Campus Q&A backend using PostgreSQL

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

model User {
  id           String   @id @default(uuid())
  username     String   @unique
  email        String   @unique
  password     String
  isVerified   Boolean  @default(false)
  bio          String   @default("")
  avatar       String   @default("")
  createdAt    DateTime @default(now())

  posts        Post[]
  comments     Comment[]
  votes        Vote[]
  savedPosts   SavedPost[]
  memberships  SpaceMembership[]
  spacesCreated Space[] @relation("UserSpaces")
  notifications Notification[]
  refreshTokens RefreshToken[]
  verificationTokens VerificationToken[]
}

model Space {
  id          String   @id @default(uuid())
  name        String
  description String   @default("")
  slug        String   @unique
  image       String   @default("")
  createdAt   DateTime @default(now())
  createdBy   String
  creator     User     @relation("UserSpaces", fields: [createdBy], references: [id])

  posts       Post[]
  members     SpaceMembership[]
}

model SpaceMembership {
  userId  String
  spaceId String
  user    User  @relation(fields: [userId], references: [id])
  space   Space @relation(fields: [spaceId], references: [id])

  @@id([userId, spaceId])
}

model Post {
  id        String   @id @default(uuid())
  title     String
  content   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  spaceId   String
  authorId  String
  space     Space    @relation(fields: [spaceId], references: [id])
  author    User     @relation(fields: [authorId], references: [id])

  votes     Int      @default(0)

  comments     Comment[]
  voteRecords  Vote[]
  savedBy   SavedPost[]
  tags      TagOnPost[]
}

model Comment {
  id        String   @id @default(uuid())
  content   String
  createdAt DateTime @default(now())

  postId    String
  authorId  String
  parentId  String?
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  author    User     @relation(fields: [authorId], references: [id])
  parent    Comment? @relation("CommentToComment", fields: [parentId], references: [id])
  replies   Comment[] @relation("CommentToComment")
}

model Vote {
  userId String
  postId String
  type   VoteType
  user   User   @relation(fields: [userId], references: [id])
  post   Post   @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@id([userId, postId])
}

enum VoteType {
  UPVOTE
  DOWNVOTE
}

model SavedPost {
  userId String
  postId String
  user   User @relation(fields: [userId], references: [id])
  post   Post @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@id([userId, postId])
}

model Notification {
  id        String   @id @default(uuid())
  type      String
  payload   Json
  read      Boolean  @default(false)
  createdAt DateTime @default(now())

  userId    String
  user      User     @relation(fields: [userId], references: [id])
}

model Tag {
  name String @id
  posts TagOnPost[]
}

model TagOnPost {
  postId String
  tagName String
  post   Post @relation(fields: [postId], references: [id], onDelete: Cascade)
  tag    Tag  @relation(fields: [tagName], references: [name])

  @@id([postId, tagName])
}

model RefreshToken {
  token  String  @id
  userId String
  user   User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
}

model VerificationToken {
  token     String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  expiresAt DateTime
}
